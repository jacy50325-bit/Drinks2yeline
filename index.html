<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>æ‰‹æ–é‡ç—‡ç´€éŒ„ ğŸ¾</title>
    
    <!-- PWA ç›¸é—œè¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#E3F2FD">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3081/3081162.png">

    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- è¼‰å…¥ Phosphor Icons (åœ–ç¤ºåº«) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- è¼‰å…¥ React å’Œ Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- è¼‰å…¥ Firebase (ä½¿ç”¨ç›¸å®¹æ€§ç‰ˆæœ¬) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        body { 
            font-family: "Microsoft JhengHei", "PingFang TC", sans-serif; 
            background-color: #E3F2FD; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #B3E5FC; border-radius: 10px; }
        
        /* å‹•ç•« */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        /* éŒ¯èª¤é®ç½© */
        #config-error { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- è¨­å®šéŒ¯èª¤æ™‚çš„æç¤ºç•«é¢ -->
    <div id="config-error" class="fixed inset-0 bg-red-50 z-[9999] flex flex-col items-center justify-center p-10 text-center">
        <div class="text-6xl mb-4">âš ï¸</div>
        <h1 class="text-2xl font-black text-red-600 mb-2">è¨­å®šå°šæœªå®Œæˆ</h1>
        <p class="text-gray-600 mb-6">è«‹æ‰“é–‹ index.html åŸå§‹ç¢¼ï¼Œå¡«å…¥æ‚¨çš„ Firebase Config èˆ‡ Gemini API Keyã€‚</p>
        <div class="bg-white p-4 rounded-xl shadow-sm text-left text-xs font-mono text-gray-500 border border-gray-200 w-full max-w-md break-all">
            <span class="text-red-500 font-bold">æª¢æŸ¥é …ç›®ï¼š</span><br>
            1. const GEMINI_API_KEY = "..."<br>
            2. const firebaseConfig = { ... }<br>
            <br>
            <span class="text-blue-500">ç›®å‰ç‹€æ…‹ï¼š</span><br>
            <span id="error-details"></span>
        </div>
    </div>

    <script type="text/babel">
        // ==========================================
        // âš ï¸ã€è«‹å‹™å¿…åœ¨æ­¤å¡«å…¥æ‚¨çš„è¨­å®šã€‘âš ï¸
        // ==========================================
        
        // 1. Gemini API Key
        const GEMINI_API_KEY = "AIzaSyBPluAL1IIXechCTxGOPZGnSGq5bLNnSyU"; // è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ Key

        // 2. Firebase Config
        const firebaseConfig = {
            // è«‹å¡«å…¥æ‚¨çš„ Firebase è¨­å®š
            apiKey: "AIzaSyC6-AtRL_0C3XJXuHrGuBNP2Kx886EESs0",
            authDomain: "drinks-adc3b.firebaseapp.com",
            projectId: "drinks-adc3b",
            storageBucket: "drinks-adc3b.firebasestorage.app",
            messagingSenderId: "564907860740",
            appId: "1:564907860740:web:628483d49cc43bf5bde651",
            measurementId: "G-GLW1T7SDFD"
        };
        
        // ==========================================
        // è¨­å®šæª¢æŸ¥é‚è¼¯ (è«‹å‹¿ä¿®æ”¹)
        // ==========================================
        function checkConfig() {
            const isConfigDefault = firebaseConfig.apiKey.includes("æ‚¨çš„");
            const isGeminiDefault = GEMINI_API_KEY.includes("æ‚¨çš„");
            
            if (isConfigDefault || isGeminiDefault) {
                document.getElementById('config-error').style.display = 'flex';
                document.getElementById('root').style.display = 'none';
                let msg = "";
                if (isConfigDefault) msg += "âŒ Firebase Config ä»ç‚ºé è¨­å€¼\n";
                if (isGeminiDefault) msg += "âŒ Gemini API Key ä»ç‚ºé è¨­å€¼\n";
                document.getElementById('error-details').innerText = msg;
                throw new Error("Configuration missing");
            }
        }
        checkConfig();

        // åˆå§‹åŒ– Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // å•Ÿç”¨é›¢ç·šå¿«å–
        db.enablePersistence().catch(err => {
            console.log('Persistence error:', err.code);
        });

        const { useState, useEffect, useRef } = React;

        const ICE_LEVELS = ["å›ºå®š", "å°‘å†°", "å¾®å†°", "å»å†°", "æº«", "ç†±"];
        const SUGAR_LEVELS = ["å›ºå®š", "ç„¡ç³–", "ä¸€åˆ†ç³–", "å¾®ç³–", "åŠç³–", "å°‘ç³–"];
        const initialDrinkState = { store: '', item: '', price: '', sugar: 'ç„¡ç³–', ice: 'å¾®å†°' };

        // Gemini API å‘¼å«å‡½æ•¸ (åŒ…å«å®‰å…¨è¨­å®š)
        const askGemini = async (payload) => {
            let url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            
            const safetySettings = [
                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
            ];

            const finalPayload = {
                ...payload,
                safetySettings: safetySettings
            };
            
            let delay = 1000;
            for (let i = 0; i < 3; i++) {
                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(finalPayload)
                    });
                    
                    if (!response.ok) {
                        const errText = await response.text();
                        console.error("API Error Detail:", errText); 
                        throw new Error(`API Request Failed: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    if (i === 2) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        };

        function App() {
            const [user, setUser] = useState(null);
            const [drinks, setDrinks] = useState([]);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [formEntries, setFormEntries] = useState([initialDrinkState]);
            
            // UI ç‹€æ…‹
            const [isSaving, setIsSaving] = useState(false);
            const [isLoginLoading, setIsLoginLoading] = useState(false);

            // AI ç‹€æ…‹
            const [aiLoading, setAiLoading] = useState(false);
            const [aiResponse, setAiResponse] = useState("");
            const [isAiModalOpen, setIsAiModalOpen] = useState(false);
            const [aiMode, setAiMode] = useState("general"); 
            const [moodInput, setMoodInput] = useState("");
            const fileInputRef = useRef(null);

            // é©—è­‰èˆ‡ç™»å…¥ (ä¿®æ”¹å¾Œï¼šæ”¯æ´ Google ç™»å…¥èˆ‡åŒ¿åç™»å…¥ä¸¦å­˜)
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser(u);
                        setIsLoginLoading(false);
                    } else {
                        // è‹¥æœªç™»å…¥ï¼Œè‡ªå‹•ä½¿ç”¨åŒ¿åç™»å…¥ (è¨ªå®¢æ¨¡å¼)
                        try {
                            await auth.signInAnonymously();
                        } catch (error) {
                            console.error("Anonymous login failed", error);
                            setIsLoginLoading(false);
                        }
                    }
                });
                return () => unsubscribe();
            }, []);

            // Google ç™»å…¥è™•ç†
            const handleGoogleLogin = async () => {
                setIsLoginLoading(true);
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    // ä½¿ç”¨ Redirect ä»¥é©æ‡‰æ‰‹æ©Ÿç‰ˆ PWA ç’°å¢ƒ
                    await auth.signInWithRedirect(provider);
                } catch (error) {
                    console.error("Login error", error);
                    alert("ç™»å…¥å¤±æ•—: " + error.message);
                    setIsLoginLoading(false);
                }
            };

            // ç™»å‡ºè™•ç†
            const handleLogout = async () => {
                if(confirm("ç¢ºå®šè¦ç™»å‡º Google å¸³è™Ÿå—ï¼Ÿ\nç™»å‡ºå¾Œå°‡åˆ‡æ›å›è¨ªå®¢æ¨¡å¼ã€‚")) {
                    setIsLoginLoading(true);
                    try {
                        await auth.signOut();
                        // ç™»å‡ºå¾Œ onAuthStateChanged æœƒè§¸ç™¼ï¼Œä¸¦è‡ªå‹•åŸ·è¡Œ signInAnonymously
                    } catch (error) {
                        console.error("Logout error", error);
                        setIsLoginLoading(false);
                    }
                }
            };

            // è³‡æ–™ç›£è½
            useEffect(() => {
                if (!user) return;
                const unsubscribe = db.collection('users').doc(user.uid).collection('drinks')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setDrinks(data);
                    }, (error) => {
                        console.error("Firestore Error:", error);
                    });
                return () => unsubscribe();
            }, [user]);

            // æ—¥æœŸé‚è¼¯
            const daysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const firstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

            const getDrinksForDate = (day) => {
                const dateStr = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                return drinks.filter(d => d.date === dateStr);
            };

            const handleDateClick = (day) => {
                const dateStr = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                setSelectedDate(dateStr);
                const existing = drinks.filter(d => d.date === dateStr);
                setFormEntries(existing.length > 0 ? existing.map(d => ({ ...d })) : [{ ...initialDrinkState }]);
                setIsModalOpen(true);
            };

            // è¡¨å–®é‚è¼¯
            const addMoreEntry = () => setFormEntries(prev => [...prev, { ...initialDrinkState }]);
            const updateEntry = (index, field, value) => {
                const newEntries = [...formEntries];
                newEntries[index] = { ...newEntries[index], [field]: value };
                setFormEntries(newEntries);
            };

            const removeEntry = async (index) => {
                const entry = formEntries[index];
                if (entry.id && user) {
                    if(confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) {
                        try {
                            await db.collection('users').doc(user.uid).collection('drinks').doc(entry.id).delete();
                        } catch (err) { 
                            alert("åˆªé™¤å¤±æ•—ï¼š" + err.message);
                        }
                    } else {
                        return;
                    }
                }
                if (formEntries.length === 1) setFormEntries([{ ...initialDrinkState }]);
                else setFormEntries(formEntries.filter((_, i) => i !== index));
            };

            const handleSubmit = async () => {
                if (!user) {
                    alert("å°šæœªç™»å…¥ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–é‡æ–°æ•´ç†é é¢ã€‚");
                    return;
                }
                
                setIsSaving(true); 

                try {
                    const valid = formEntries.filter(e => e.store && e.item && e.price);
                    
                    if (valid.length === 0 && formEntries[0].store === '') {
                         setIsModalOpen(false);
                         setIsSaving(false);
                         return;
                    }

                    for (const entry of valid) {
                        const data = {
                            store: entry.store, item: entry.item, price: Number(entry.price),
                            sugar: entry.sugar, ice: entry.ice, date: selectedDate, updatedAt: new Date().toISOString()
                        };
                        if (entry.id) {
                            await db.collection('users').doc(user.uid).collection('drinks').doc(entry.id).set(data, { merge: true });
                        } else {
                            await db.collection('users').doc(user.uid).collection('drinks').add({ ...data, createdAt: new Date().toISOString() });
                        }
                    }
                    
                    setIsModalOpen(false);
                    
                } catch (e) { 
                    console.error("Save failed:", e);
                    if (e.code === 'permission-denied') {
                        alert("å„²å­˜å¤±æ•—ï¼šæ¬Šé™è¢«æ‹’çµ•ã€‚\nè«‹ç¢ºèª Firebase Rules è¨­å®šç‚ºå…è¨±è®€å¯«ã€‚");
                    } else {
                        alert("å„²å­˜å¤±æ•—ï¼š" + e.message);
                    }
                } finally {
                    setIsSaving(false); 
                }
            };

            // AI åŠŸèƒ½
            const handleImageScan = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setAiLoading(true); setAiMode("general"); setIsAiModalOpen(true); setAiResponse("æ­£åœ¨æƒæç…§ç‰‡... ğŸˆâ€â¬›");
                const reader = new FileReader();
                reader.onloadend = async () => {
                    try {
                        const res = await askGemini({
                            contents: [{ parts: [{ text: "è¾¨è­˜ç…§ç‰‡æ‰‹æ–è³‡è¨Šå›å‚³ JSONï¼š{store, item, price, sugar, ice}" }, { inlineData: { mimeType: "image/png", data: reader.result.split(',')[1] } }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        });
                        const parsed = JSON.parse(res.candidates[0].content.parts[0].text);
                        if (parsed.store || parsed.item) {
                            const updated = [...formEntries];
                            updated[0] = { ...updated[0], ...parsed };
                            setFormEntries(updated);
                            setAiResponse("âœ¨ æƒææˆåŠŸï¼è«‹ç¢ºèªæ¬„ä½ã€‚ğŸ¾");
                            setTimeout(() => setIsAiModalOpen(false), 1500);
                        }
                    } catch (err) { setAiResponse("è¾¨è­˜å¤±æ•—ï¼š" + err.message); }
                    finally { setAiLoading(false); }
                };
                reader.readAsDataURL(file);
            };

            const handleAiAnalyze = async () => {
                setAiLoading(true); setAiMode("general"); setIsAiModalOpen(true); setAiResponse("æ­£åœ¨åˆ†ææœ¬æœˆæ•¸æ“š... ğŸ“Š");
                
                const curMonth = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}`;
                const monthDrinks = drinks.filter(d => d.date.startsWith(curMonth));

                if (monthDrinks.length === 0) {
                    setAiResponse(`æœ¬æœˆ (${curMonth}) é‚„æ²’æœ‰ä»»ä½•é£²æ–™ç´€éŒ„å–”ï¼\n\nä½ æ˜¯ç¥å—ï¼ŸğŸ˜‡\n(æˆ–è€…åªæ˜¯é‚„æ²’è¨˜å¸³ï¼Ÿè¶•å¿«å»è¨˜ä¸€ç­†å§ï¼)`);
                    setAiLoading(false);
                    return;
                }

                try {
                    const res = await askGemini({ 
                        contents: [{ parts: [{ text: `ä½ æ˜¯ä¸€å€‹æ¯’èˆŒä½†é—œå¿ƒå¥åº·çš„ç‡Ÿé¤Šå¸«ã€‚åˆ†æä»¥ä¸‹æ‰‹æ–ç´€éŒ„ä¸¦çµ¦äºˆå¹½é»˜å»ºè­°ï¼ˆ200å­—å…§ï¼‰ï¼Œå¦‚æœè³‡æ–™é¡¯ç¤ºå–å¾ˆå¤šç³–ï¼Œè«‹æ¯«ä¸ç•™æƒ…åœ°åæ§½ï¼š${JSON.stringify(monthDrinks)}` }] }] 
                    });
                    
                    if (res.candidates && res.candidates[0] && res.candidates[0].content) {
                        setAiResponse(res.candidates[0].content.parts[0].text);
                    } else if (res.promptFeedback && res.promptFeedback.blockReason) {
                         setAiResponse("AI è¦ºå¾—ä½ çš„é£²æ–™ç´€éŒ„å¤ªé©šäººï¼Œé©šè¨åˆ°èªªä¸å‡ºè©±äº†... (å…§å®¹å¯èƒ½æ¶‰åŠæ•æ„Ÿè©è¢«é˜»æ“‹ ğŸ˜…)");
                    } else {
                        setAiResponse("AI æš«æ™‚ç„¡æ³•å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                    }
                } catch (e) { 
                    console.error(e);
                    setAiResponse("åˆ†æå¤±æ•—ï¼š" + e.message); 
                }
                finally { setAiLoading(false); }
            };

            const handleDailyQuote = async () => {
                setAiLoading(true); setAiMode("general"); setIsAiModalOpen(true); setAiResponse("æ­£åœ¨æŠ½å–ä»Šæ—¥éˆæ„Ÿ... â˜•");
                const topics = ["ç”Ÿæ´»å°ç¢ºå¹¸", "å·¥ä½œç–²æ†Šæ™‚çš„å®‰æ…°", "å–é£²æ–™çš„å“²å­¸", "è²“å’ªçš„æ‡¶æ•£æ™ºæ…§"];
                const topic = topics[Math.floor(Math.random() * topics.length)];
                try {
                    const res = await askGemini({ 
                        contents: [{ parts: [{ text: `è«‹çµ¦æˆ‘ä¸€å¥é—œæ–¼ã€Œ${topic}ã€çš„çŸ­å¥ï¼ˆ20å­—å…§ï¼‰ï¼Œé¢¨æ ¼è¦æº«æš–ç™‚ç™’æˆ–å¸¶é»å¹½é»˜ï¼Œæœ€å¾ŒåŠ ä¸Šä¸€å€‹å¯æ„›çš„é¡æ–‡å­—ã€‚` }] }]
                    });
                    setAiResponse(res.candidates[0].content.parts[0].text);
                } catch (e) { setAiResponse("ä»Šå¤©ä¹Ÿæ˜¯é©åˆå–é£²æ–™çš„å¥½æ—¥å­ (â‰§â–½â‰¦)"); } 
                finally { setAiLoading(false); }
            };

            const handleCalorieScout = async (drink) => {
                setAiLoading(true); setAiMode("general"); setIsAiModalOpen(true); setAiResponse("è¨ˆç®—ç†±é‡ä¸­... ğŸ”¥");
                try {
                    const res = await askGemini({ contents: [{ parts: [{ text: `ä¼°ç®— ${drink.store} ${drink.item} (${drink.sugar}/${drink.ice}) çš„ç†±é‡ï¼Œä¸¦æä¾›ä¸€å€‹ã€Œè’è¬¬å¥½ç¬‘çš„é‹å‹•æ–¹å¼ã€ä¾†æ¶ˆè€—é€™äº›ç†±é‡ï¼ˆä¾‹å¦‚ï¼šæ¿€çƒˆåœ°é»é ­ 5000 æ¬¡ï¼‰ã€‚` }] }] });
                    setAiResponse(res.candidates[0].content.parts[0].text);
                } catch (e) { setAiResponse("è¨ˆç®—å¤±æ•—ã€‚"); }
                finally { setAiLoading(false); }
            };

            const openMoodMixer = () => {
                setMoodInput("");
                setAiMode("mood");
                setIsAiModalOpen(true);
                setAiResponse("");
            };

            const handleMoodSubmit = async () => {
                if (!moodInput) return;
                setAiLoading(true); setAiResponse("æ­£åœ¨èª¿è£½é…æ–¹ä¸­... ğŸ§ª");
                try {
                    const res = await askGemini({ 
                        contents: [{ parts: [{ text: `ä½¿ç”¨è€…ç¾åœ¨çš„å¿ƒæƒ…æ˜¯ï¼šã€Œ${moodInput}ã€ã€‚è«‹æ¨è–¦ä¸€æ¬¾ã€Œå°ç£æ‰‹æ–é£²æ–™ã€ï¼ˆå¯æŒ‡å®šå“ç‰Œæˆ–é€šç”¨ç¨®é¡ï¼Œå«ç”œåº¦å†°å¡Šï¼‰ã€‚æ ¼å¼ï¼šğŸ¹ æ¨è–¦ï¼š[é£²å“åç¨±] ([ç”œåº¦/å†°å¡Š])\nğŸ’¬ ç†ç”±ï¼š[ä¸€æ®µæº«æš–æˆ–å¹½é»˜çš„ç†ç”±ï¼Œ50å­—å…§]` }] }],
                        systemInstruction: { parts: [{ text: "ä½ æ˜¯ä¸€ä½é€éé£²æ–™ä¾†ç™‚ç™’äººå¿ƒçš„æ‰‹æ–æ¯èª¿é…’å¸«ã€‚" }] }
                    });
                    setAiResponse(res.candidates[0].content.parts[0].text);
                } catch (e) { setAiResponse("ç³»çµ±å¿™ç·šä¸­ï¼Œå–æ¯æ°´å†·éœä¸€ä¸‹å§ï¼(ãƒ»âˆ€ãƒ») " + e.message); }
                finally { setAiLoading(false); }
            };

            const todayStr = new Date().toISOString().split('T')[0];
            const curMonthStr = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}`;
            const monthlyTotal = drinks.filter(d => d.date.startsWith(curMonthStr)).reduce((sum, d) => sum + d.price, 0);

            // åˆ¤æ–·æŒ‰éˆ•é¡¯ç¤ºå…§å®¹
            const renderAuthButton = () => {
                if (isLoginLoading) return <span className="animate-pulse">ğŸ”„ è™•ç†ä¸­...</span>;
                if (user && !user.isAnonymous) {
                    return <span onClick={handleLogout} className="cursor-pointer hover:underline flex items-center gap-1"><i className="ph-fill ph-user-circle"></i> {user.displayName || "ä½¿ç”¨è€…"} (ç™»å‡º)</span>;
                }
                return <span onClick={handleGoogleLogin} className="cursor-pointer hover:text-[#0277BD] transition-colors flex items-center gap-1 animate-pulse"><i className="ph-bold ph-google-logo"></i> é»æ­¤ç™»å…¥åŒæ­¥</span>;
            };

            return (
                <div className="min-h-[100dvh] text-[#37474F] font-sans overflow-hidden select-none flex flex-col relative">
                    {/* èƒŒæ™¯è£é£¾ */}
                    <div className="fixed top-20 left-10 text-4xl opacity-10 pointer-events-none animate-float">ğŸ«§</div>
                    <div className="fixed bottom-20 right-10 text-4xl opacity-10 pointer-events-none animate-bounce">ğŸ¬</div>
                    <div className="fixed bottom-10 left-10 text-3xl opacity-10 pointer-events-none">ğŸˆâ€â¬›</div>

                    <div className="h-[env(safe-area-inset-top,0px)] bg-transparent w-full"></div>

                    <div className="flex-1 overflow-y-auto pt-10 pb-20 px-4 custom-scrollbar">
                        <header className="max-w-4xl mx-auto mb-6 text-center relative">
                            {/* ç™»å…¥æŒ‰éˆ•å€åŸŸ */}
                            <div className="flex items-center justify-center gap-1.5 mb-1 text-[#0288D1] font-bold text-[10px] md:text-xs">
                                {renderAuthButton()}
                            </div>
                            
                            <h1 className="text-3xl md:text-5xl font-black text-[#263238] mb-4 tracking-tighter leading-tight relative">ğŸ¾ æ‰‹æ–é‡ç—‡ç´€éŒ„ ğŸˆâ€â¬›</h1>
                            <div className="space-y-3">
                                <div className="flex flex-wrap justify-center items-center gap-2 text-xs font-bold bg-white/70 backdrop-blur-md px-5 py-3 rounded-full w-fit mx-auto border border-white shadow-md">
                                    <span className="bg-[#E1F5FE] px-3 py-1 rounded-full text-[#0288D1]">ğŸ’™ $ {monthlyTotal}</span>
                                    <span className="bg-gray-100 px-3 py-1 rounded-full text-[#263238]">ğŸ¾ {drinks.filter(d => d.date.startsWith(curMonthStr)).length} æ¯</span>
                                </div>
                                <div className="flex justify-center flex-wrap gap-2">
                                    <button onClick={handleAiAnalyze} className="bg-[#263238] text-white px-4 py-2 rounded-full text-[11px] font-bold shadow-md active:scale-95 transition-transform flex items-center gap-1">
                                        <i className="ph-bold ph-sparkle"></i> é€±å ±
                                    </button>
                                    <button onClick={handleDailyQuote} className="bg-[#0288D1] text-white px-4 py-2 rounded-full text-[11px] font-bold shadow-md active:scale-95 transition-transform flex items-center gap-1">
                                        <i className="ph-bold ph-quotes"></i> èªéŒ„
                                    </button>
                                    <button onClick={openMoodMixer} className="bg-[#FF7043] text-white px-4 py-2 rounded-full text-[11px] font-bold shadow-md active:scale-95 transition-transform flex items-center gap-1">
                                        <i className="ph-bold ph-magic-wand"></i> å¿ƒæƒ…ç‰¹èª¿
                                    </button>
                                </div>
                            </div>
                        </header>

                        <main className="max-w-5xl mx-auto">
                            <div className="flex items-center justify-between mb-4 px-1">
                                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1))} className="p-2.5 bg-white rounded-xl shadow-sm text-[#0288D1] active:scale-90 transition-transform"><i className="ph-bold ph-caret-left"></i></button>
                                <div className="text-md font-black text-[#263238] bg-white px-6 py-2 rounded-full border-2 border-white shadow-sm">{currentDate.getFullYear()} / {currentDate.getMonth() + 1}</div>
                                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1))} className="p-2.5 bg-white rounded-xl shadow-sm text-[#0288D1] active:scale-90 transition-transform"><i className="ph-bold ph-caret-right"></i></button>
                            </div>

                            <div className="bg-white/90 backdrop-blur rounded-[2rem] shadow-xl overflow-hidden border-[6px] md:border-[12px] border-white transition-all">
                                <div className="grid grid-cols-7 bg-[#263238] py-2 text-center font-black text-white text-[9px] uppercase">
                                    {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => <div key={d} className="py-2">{d}</div>)}
                                </div>
                                <div className="grid grid-cols-7">
                                    {Array.from({ length: firstDayOfMonth(currentDate.getFullYear(), currentDate.getMonth()) }).map((_, i) => <div key={`empty-${i}`} className="h-20 md:h-40 bg-gray-50/10 border-b border-r border-gray-100"></div>)}
                                    {Array.from({ length: daysInMonth(currentDate.getFullYear(), currentDate.getMonth()) }).map((_, i) => {
                                        const day = i + 1;
                                        const dDrinks = getDrinksForDate(day);
                                        const isToday = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}` === todayStr;
                                        return (
                                            <div key={day} onClick={() => handleDateClick(day)} className="h-20 md:h-40 border-b border-r border-gray-100 p-1 cursor-pointer hover:bg-[#B3E5FC]/40 overflow-hidden relative group">
                                                <div className={`w-6 h-6 flex items-center justify-center rounded-lg text-[10px] font-black ${isToday ? 'bg-[#0288D1] text-white shadow-sm rotate-3' : 'text-[#263238]'}`}>{day}</div>
                                                <div className="mt-1 flex gap-0.5 px-0.5">
                                                    {dDrinks.length >= 1 && <span className="text-[10px]">ğŸ’™</span>}
                                                    {dDrinks.length >= 2 && <span className="text-[10px]">ğŸ–¤</span>}
                                                </div>
                                                <div className="mt-0.5 space-y-0.5 overflow-hidden">
                                                    {dDrinks.slice(0, 2).map((d, idx) => (
                                                        <div key={idx} className="flex items-center justify-between text-[7px] md:text-[10px] bg-[#263238] text-white px-1 py-0.5 rounded-sm truncate font-bold shadow-sm">
                                                            <span className="truncate flex-1">{d.item}</span>
                                                            <button onClick={(e) => { e.stopPropagation(); handleCalorieScout(d); }} className="ml-0.5 text-orange-300 active:scale-125" title="ç†±é‡ä¼°ç®—"><i className="ph-fill ph-lightning"></i></button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </main>
                    </div>

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-[#263238]/95 backdrop-blur-xl flex flex-col items-center justify-end z-50 overflow-hidden pt-[env(safe-area-inset-top,0px)]">
                            <div className="bg-white w-full max-w-2xl h-[94vh] rounded-t-[3rem] shadow-2xl flex flex-col border-x-[8px] border-t-[8px] border-[#B3E5FC] animate-in slide-in-from-bottom-20 duration-300 overflow-hidden relative pb-[env(safe-area-inset-bottom,0px)]">
                                <div className="p-5 border-b border-gray-100 flex-shrink-0 bg-white">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-xl font-black text-[#263238]">è£œçµ¦ç«™ ğŸ¾</h3>
                                        <button onClick={() => setIsModalOpen(false)} className="p-2.5 bg-gray-100 rounded-full text-gray-400 active:scale-90"><i className="ph-bold ph-x"></i></button>
                                    </div>
                                    <button onClick={() => fileInputRef.current.click()} className="w-full mb-3 py-3 border-2 border-dashed border-[#0288D1] text-[#0288D1] rounded-[1.2rem] font-black flex items-center justify-center gap-2 text-sm shadow-sm active:scale-95 bg-white"><i className="ph-bold ph-camera"></i> âœ¨ AI å½±åƒè‡ªå‹•å¡«å–®</button>
                                    <input type="file" accept="image/*" ref={fileInputRef} onChange={handleImageScan} className="hidden" />
                                    <div className="text-center py-2 bg-[#E1F5FE] rounded-[1rem] text-[#0288D1] font-black text-sm border border-white/50 shadow-inner">ğŸ¾ {selectedDate} ğŸ’™</div>
                                </div>

                                <div className="flex-1 overflow-y-auto p-5 space-y-8 custom-scrollbar bg-gray-50/50">
                                    {formEntries.map((entry, index) => (
                                        <div key={index} className="relative p-5 pt-12 bg-white rounded-[1.8rem] border-2 border-dashed border-gray-200 shadow-sm">
                                            <div className="absolute top-4 left-5 bg-[#263238] text-white px-4 py-1 rounded-full text-[10px] font-black shadow-sm z-10">{entry.id ? "å·²å­˜ç´€éŒ„ #" : "æ–°å¢ç´€éŒ„ #"}{index + 1}</div>
                                            <button type="button" onClick={() => removeEntry(index)} className="absolute top-4 right-5 bg-red-100 text-red-500 p-2 rounded-full active:scale-75 shadow-sm hover:bg-red-200 transition-colors"><i className="ph-bold ph-trash"></i></button>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                                <input required className="w-full px-5 py-3.5 rounded-2xl border-2 border-transparent focus:border-[#B3E5FC] bg-gray-50 font-bold outline-none shadow-inner text-base" placeholder="åº—å®¶..." value={entry.store} onChange={(e) => updateEntry(index, 'store', e.target.value)} />
                                                <input required className="w-full px-5 py-3.5 rounded-2xl border-2 border-transparent focus:border-[#B3E5FC] bg-gray-50 font-bold outline-none shadow-inner text-base" placeholder="é£²å“..." value={entry.item} onChange={(e) => updateEntry(index, 'item', e.target.value)} />
                                            </div>
                                            <input required type="number" className="w-full mt-3 px-5 py-3.5 rounded-2xl border-2 border-transparent focus:border-[#B3E5FC] bg-gray-50 font-bold shadow-inner text-base" placeholder="é‡‘é¡ $" value={entry.price} onChange={(e) => updateEntry(index, 'price', e.target.value)} />
                                            <div className="mt-6 grid grid-cols-3 md:grid-cols-6 gap-1.5">{SUGAR_LEVELS.map(l => <button key={l} type="button" onClick={() => updateEntry(index, 'sugar', l)} className={`py-3 rounded-xl border-2 text-[9px] font-black transition-all ${entry.sugar === l ? 'bg-[#263238] text-white border-[#263238] shadow-md' : 'bg-white text-gray-400 border-gray-100'}`}>{l}</button>)}</div>
                                            <div className="mt-3 grid grid-cols-3 md:grid-cols-6 gap-1.5">{ICE_LEVELS.map(l => <button key={l} type="button" onClick={() => updateEntry(index, 'ice', l)} className={`py-3 rounded-xl border-2 text-[9px] font-black transition-all ${entry.ice === l ? 'bg-[#0288D1] text-white border-[#0288D1] shadow-md' : 'bg-white text-gray-400 border-gray-100'}`}>{l}</button>)}</div>
                                        </div>
                                    ))}
                                    <div className="h-10"></div>
                                </div>

                                <div className="p-5 bg-white border-t border-gray-100 flex-shrink-0 flex flex-row gap-3 pb-[calc(env(safe-area-inset-bottom,1rem)+1.5rem)] shadow-[0_-10px_20px_rgba(0,0,0,0.02)]">
                                    <button onClick={handleSubmit} disabled={isSaving} className="flex-[1.6] py-5 bg-[#263238] text-white rounded-[1.8rem] font-black text-xl shadow-lg border-b-[8px] border-gray-900 active:translate-y-1 active:border-b-[4px] transition-all hover:bg-black disabled:opacity-50 disabled:active:translate-y-0">
                                        {isSaving ? "å„²å­˜ä¸­..." : "å…¨éƒ½ä¿å­˜ ğŸ’™"}
                                    </button>
                                    <button onClick={addMoreEntry} disabled={isSaving} className="flex-1 py-5 border-2 border-dashed border-[#B3E5FC] text-[#0288D1] rounded-[1.8rem] font-black active:scale-95 text-xs flex items-center justify-center gap-1 bg-white hover:bg-[#E1F5FE] transition-colors shadow-sm disabled:opacity-50">ğŸ¾ å†æ·»ä¸€æ¯</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {isAiModalOpen && (
                        <div className="fixed inset-0 bg-[#263238]/90 backdrop-blur-xl flex items-center justify-center p-6 z-[100] pt-[env(safe-area-inset-top,1rem)]">
                            <div className="bg-white rounded-[2rem] shadow-2xl w-full max-w-lg border-[8px] border-[#0288D1] p-6 text-center animate-in zoom-in duration-300 relative">
                                <div className="absolute -top-6 left-1/2 -translate-x-1/2 bg-[#0288D1] text-white px-6 py-2 rounded-full font-black text-sm shadow-lg">âœ¨ AI å¯¦é©—å®¤ ğŸˆâ€â¬›</div>
                                <button onClick={() => setIsAiModalOpen(false)} className="absolute top-4 right-4 text-gray-300 hover:text-gray-500"><i className="ph-bold ph-x text-xl"></i></button>

                                {aiMode === "mood" && !aiLoading && !aiResponse && (
                                    <div className="mt-8 mb-4">
                                        <div className="text-[#37474F] font-black text-lg mb-4">ä»Šå¤©å¿ƒæƒ…å¦‚ä½•ï¼Ÿ</div>
                                        <div className="flex flex-wrap justify-center gap-2 mb-4">
                                            {['æœ‰é»ç´¯', 'è¶…ç´šé–‹å¿ƒ', 'æƒ³é›¢è·', 'å¤±æˆ€äº†', 'åªæƒ³è€å»¢'].map(m => (
                                                <button key={m} onClick={() => setMoodInput(m)} className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${moodInput === m ? 'bg-[#FF7043] text-white shadow-md' : 'bg-gray-100 text-gray-500'}`}>{m}</button>
                                            ))}
                                        </div>
                                        <input 
                                            type="text" 
                                            value={moodInput}
                                            onChange={(e) => setMoodInput(e.target.value)}
                                            placeholder="æˆ–è¼¸å…¥ä½ çš„å¿ƒæƒ…..."
                                            className="w-full px-5 py-3 rounded-xl border-2 border-gray-200 bg-gray-50 focus:border-[#FF7043] outline-none text-center font-bold text-[#37474F] mb-4"
                                        />
                                        <button 
                                            onClick={handleMoodSubmit}
                                            disabled={!moodInput}
                                            className="w-full py-3 bg-[#FF7043] text-white rounded-xl font-black shadow-md active:scale-95 disabled:opacity-50 disabled:active:scale-100 transition-all flex items-center justify-center gap-2"
                                        >
                                            <i className="ph-bold ph-magic-wand"></i> èª¿è£½å°ˆå±¬é…æ–¹
                                        </button>
                                    </div>
                                )}

                                {aiLoading && (
                                    <div className="py-10">
                                        <div className="animate-spin text-[#0288D1] text-4xl mb-4 mx-auto w-fit"><i className="ph-bold ph-spinner"></i></div>
                                        <p className="text-gray-400 text-xs font-bold animate-pulse">{aiResponse || "AI æ­£åœ¨æ€è€ƒä¸­..."}</p>
                                    </div>
                                )}

                                {!aiLoading && aiResponse && (
                                    <>
                                        <div className="p-4 rounded-full mx-auto w-fit mt-4 bg-[#E1F5FE] text-[#0288D1] text-3xl"><i className="ph-bold ph-sparkle"></i></div>
                                        <div className="bg-gray-50 p-6 mt-6 rounded-[1.5rem] border-2 border-gray-100 text-[#37474F] text-sm max-h-[40vh] overflow-y-auto custom-scrollbar font-bold leading-relaxed text-left whitespace-pre-wrap">
                                            {aiResponse}
                                        </div>
                                        {aiMode === "mood" ? (
                                            <button onClick={() => { setAiResponse(""); setMoodInput(""); }} className="mt-6 px-8 py-3 bg-gray-100 text-gray-500 rounded-full font-black text-xs active:scale-95 transition-all">å†ç©ä¸€æ¬¡</button>
                                        ) : (
                                            <button onClick={() => { setIsAiModalOpen(false); }} className="mt-8 px-12 py-4 bg-[#263238] text-white rounded-full font-black shadow-md active:scale-95 transition-all hover:bg-black">çŸ¥é“äº† ğŸ¾</button>
                                        )}
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>